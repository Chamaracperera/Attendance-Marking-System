<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Location Match Checker</title>
    <link rel="stylesheet" href="popup_alert.css"> <!-- Link to external CSS file -->
    <script>
        const predefinedLocations = [
            { lat: 6.927079, lon: 79.861243 }, // Main Faculty Location
            { lat: 6.8215, lon: 80.0423 }, // Lecture Hall 1
            { lat: 6.8208, lon: 80.0415 }, // Lecture Hall 2
            { lat: 6.8213, lon: 80.0420 }, // Laboratory 1
            { lat: 6.8210, lon: 80.0418 }, // Library
            { lat: 6.8209, lon: 80.0422 }, // Administrative Office
            { lat: 6.8212, lon: 80.0425 }  // Department of ICT
        ];
        let isInClassroom = false; // To track if the user is within any predefined location

        function showCustomAlert(message) {
            document.getElementById('custom-alert-text').innerText = message;
            document.getElementById('custom-alert').style.display = 'block';
            document.getElementById('alert-overlay').style.display = 'block';
        }

        function closeCustomAlert() {
            document.getElementById('custom-alert').style.display = 'none';
            document.getElementById('alert-overlay').style.display = 'none';
            
            if (isInClassroom) {
                // Redirect to the selection page if the user is in the classroom
                window.location.href = "scan_qr.html";
            }
        }

        function checkLocationServices() {
            if (!navigator.geolocation) {
                showCustomAlert("Geolocation is not supported by your browser.");
                return;
            }

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    showCustomAlert("Location services are enabled.");
                    const userLocation = {
                        lat: position.coords.latitude,
                        lon: position.coords.longitude
                    };
                    checkLocationMatch(userLocation, predefinedLocations);
                },
                (error) => {
                    if (error.code === error.PERMISSION_DENIED) {
                        showCustomAlert("Please enable your device's location services to continue.");
                    } else if (error.code === error.POSITION_UNAVAILABLE) {
                        showCustomAlert("Location information is currently unavailable. Please turn on your device location.");
                    } else if (error.code === error.TIMEOUT) {
                        showCustomAlert("Request for location timed out. Please try again.");
                    } else {
                        showCustomAlert("An unknown error occurred. Please try again.");
                    }
                },
                { timeout: 5000 }
            );
        }

        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 6371;
            const dLat = deg2rad(lat2 - lat1);
            const dLon = deg2rad(lon2 - lon1);
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) *
                Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }

        function deg2rad(deg) {
            return deg * (Math.PI / 180);
        }

        function checkLocationMatch(userLocation, predefinedLocations) {
            const allowedDistance = 0.1; // 100 meters
            isInClassroom = predefinedLocations.some(predefinedLocation => {
                return getDistance(userLocation.lat, userLocation.lon, predefinedLocation.lat, predefinedLocation.lon) <= allowedDistance;
            });

            if (isInClassroom) {
                showCustomAlert("You are in the classroom. Please scan the QR code to mark your attendance.");
            } else {
                showCustomAlert("You are not in the classroom. Sorry, you can't mark the attendance.");
            }
        }

        window.onload = function() {
            checkLocationServices();
        };
    </script>
</head>
<body>

    <!-- Overlay for background blur effect -->
    <div id="alert-overlay" class="alert-overlay" onclick="closeCustomAlert()"></div>

    <!-- Custom alert box -->
    <div id="custom-alert" class="custom-alert">
        <p id="custom-alert-text"></p>
        <button onclick="closeCustomAlert()">OK</button>
    </div>

</body>
</html>
