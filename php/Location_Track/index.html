<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Location Match Checker</title>
  <link rel="stylesheet" href="popup_alert.css">
</head>
<body>

  

  <!-- Overlay for background blur effect -->
  <div id="alert-overlay" class="alert-overlay" onclick="closeCustomAlert()"></div>

  <!-- Custom alert box -->
  <div id="custom-alert" class="custom-alert">
    <p id="custom-alert-text"></p>
    <button onclick="closeCustomAlert()">OK</button>
  </div>

  <script>
    // Predefined location
    const predefinedLocations = [
      { lat: 6.817442, lon: 80.045071, radius: 0.3 }
    ];

    let isInClassroom = false;

    function showCustomAlert(message) {
      document.getElementById('custom-alert-text').innerText = message;
      document.getElementById('custom-alert').style.display = 'block';
      document.getElementById('alert-overlay').style.display = 'block';
    }

    function closeCustomAlert() {
      document.getElementById('custom-alert').style.display = 'none';
      document.getElementById('alert-overlay').style.display = 'none';

      if (isInClassroom) {
        window.location.href = "scan_qr.html"; // Redirect if inside the area
      } else {
        window.location.href = "../student/Student_Dashboard.php"; // Redirect if outside the area
      }
    }

    function checkLocationServices() {
      if (!navigator.geolocation) {
        showCustomAlert("Geolocation is not supported by your browser.");
        return;
      }

      navigator.geolocation.getCurrentPosition(
        (position) => {
          const userLocation = {
            lat: position.coords.latitude,
            lon: position.coords.longitude
          };
          checkLocationMatch(userLocation, predefinedLocations);
        },
        (error) => {
          switch (error.code) {
            case error.PERMISSION_DENIED:
              showCustomAlert("Please enable your device's location services to continue.");
              break;
            case error.POSITION_UNAVAILABLE:
              showCustomAlert("Location information is currently unavailable. Please turn on your device location.");
              break;
            case error.TIMEOUT:
              showCustomAlert("Request for location timed out. Please try again.");
              break;
            default:
              showCustomAlert("An unknown error occurred. Please try again.");
          }
        },
        { timeout: 5000 }
      );
    }

    function getDistance(lat1, lon1, lat2, lon2) {
      const R = 6371;
      const dLat = deg2rad(lat2 - lat1);
      const dLon = deg2rad(lon2 - lon1);
      const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) *
                Math.sin(dLon / 2) * Math.sin(dLon / 2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;
    }

    function deg2rad(deg) {
      return deg * (Math.PI / 180);
    }

    function checkLocationMatch(userLocation, predefinedLocations) {
      isInClassroom = predefinedLocations.some(location => {
        const distance = getDistance(userLocation.lat, userLocation.lon, location.lat, location.lon);
        const allowedDistance = location.radius || 0.1;
        return distance <= allowedDistance;
      });

      if (isInClassroom) {
        showCustomAlert("You are in the Class Room. Please scan the QR code to mark your attendance.");
      } else {
        showCustomAlert("You are not in the Class Room. Sorry, you can't mark the attendance.");
      }
    }

    window.onload = function() {
      checkLocationServices();
    };
  </script>

</body>
</html>
